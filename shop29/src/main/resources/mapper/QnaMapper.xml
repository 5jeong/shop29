<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.toy2.shop29.qna.QnaMapper">

    <!-- CREATE -->
    <insert id="insert" parameterType="com.toy2.shop29.qna.domain.QnaDto" useGeneratedKeys="true" keyProperty="qnaId">
        INSERT INTO `Qna`(
            `user_id`, -- 사용자 ID
            `qna_type_id`, -- 문의유형 ID
            `title`, -- 제목
            `content`, -- 내용
            `order_id`, -- 주문 ID
            `product_id`, -- 상품 ID
            `created_id`, -- 생성자 ID
            `updated_id` -- 수정자 ID
        )
        VALUES(
            #{userId},
            #{qnaTypeId},
            #{title},
            #{content},
            #{orderId},
            #{productId},
            #{userId},
            #{userId}
        );
    </insert>

    <!-- READ -->

    <resultMap id="qnaMap" type="com.toy2.shop29.qna.domain.QnaDto">
        <id column="qna_id" property="qnaId"/>
        <result column="user_id" property="userId"/>
        <result column="qna_type_id" property="qnaTypeId"/>
        <result column="title" property="title"/>
        <result column="content" property="content"/>
        <result column="order_id" property="orderId"/>
        <result column="product_id" property="productId"/>
        <result column="created_id" property="createdId"/>
        <result column="created_time" property="createdTime"/>
        <result column="updated_id" property="updatedId"/>
        <result column="updated_time" property="updatedTime"/>
        <result column="is_deleted" property="isDeleted"/>
        <result column="deleted_time" property="deletedTime"/>
        <association property="qnaType" resultMap="qnaTypeMap"/>
        <association property="user" resultMap="userMap"/>
        <association property="qnaAnswer" resultMap="qnaAnswerMap"/>
        <collection property="attachments" resultMap="attachmentMap"/>
    </resultMap>

    <resultMap id="qnaTypeMap" type="com.toy2.shop29.qna.domain.QnaTypeDto">
        <id column="qt_qna_type_id" property="qnaTypeId"/>
        <result column="qt_parent_qna_type_id" property="parentQnaTypeId"/>
        <result column="qt_name" property="name"/>
        <result column="qt_description" property="description"/>
        <result column="qt_is_order_id_active" property="isOrderIdActive"/>
        <result column="qt_is_product_id_active" property="isProductIdActive"/>
        <result column="qt_is_active" property="isActive"/>
        <result column="qt_created_id" property="createdId"/>
        <result column="qt_created_time" property="createdTime"/>
        <result column="qt_updated_id" property="updatedId"/>
        <result column="qt_updated_time" property="updatedTime"/>
        <association property="parentQnaType" resultMap="parentQnaTypeMap"/>
    </resultMap>

    <resultMap id="parentQnaTypeMap" type="com.toy2.shop29.qna.domain.ParentQnaTypeDto">
        <id column="pqt_parent_qna_type_id" property="parentQnaTypeId"/>
        <result column="pqt_name" property="name"/>
        <result column="pqt_description" property="description"/>
        <result column="pqt_is_active" property="isActive"/>
        <result column="pqt_created_id" property="createdId"/>
        <result column="pqt_created_time" property="createdTime"/>
        <result column="pqt_updated_id" property="updatedId"/>
        <result column="pqt_updated_time" property="updatedTime"/>
    </resultMap>

    <resultMap id="userMap" type="com.toy2.shop29.qna.domain.UserForQnaDto">
        <id column="u_user_id" property="userId"/>
        <result column="u_user_name" property="userName"/>
        <result column="u_user_role" property="userRole"/>
        <result column="u_phone_number" property="phoneNumber"/>
        <result column="u_email" property="email"/>
    </resultMap>

    <resultMap id="qnaAnswerMap" type="com.toy2.shop29.qna.domain.QnaAnswerDto">
        <id column="qa_qna_answer_id" property="qnaAnswerId"/>
        <result column="qa_admin_id" property="adminId"/>
        <result column="qa_qna_id" property="qnaId"/>
        <result column="qa_content" property="content"/>
        <result column="qa_is_deleted" property="isDeleted"/>
        <result column="qa_deleted_time" property="deletedTime"/>
        <result column="qa_deleted_id" property="deletedId"/>
        <result column="qa_created_id" property="createdId"/>
        <result column="qa_created_time" property="createdTime"/>
        <result column="qa_updated_id" property="updatedId"/>
        <result column="qa_updated_time" property="updatedTime"/>
    </resultMap>

    <resultMap id="attachmentMap" type="com.toy2.shop29.qna.domain.AttachmentDto">
        <id column="a_attachment_id" property="attachmentId"/>
        <result column="a_qna_id" property="qnaId"/>
        <result column="a_file_name" property="fileName"/>
        <result column="a_file_path" property="filePath"/>
        <result column="a_width" property="width"/>
        <result column="a_height" property="height"/>
        <result column="a_size" property="size"/>
        <result column="a_extension" property="extension"/>
        <result column="a_is_active" property="isActive"/>
        <result column="a_created_id" property="createdId"/>
        <result column="a_created_time" property="createdTime"/>
        <result column="a_updated_id" property="updatedId"/>
        <result column="a_updated_time" property="updatedTime"/>
    </resultMap>

    <select id="selectAllWith" parameterType="map" resultMap="qnaMap">
        SELECT
            -- Qna, QnaType
            qqt.*,

            -- QnaAnswer
            qa.qna_answer_id AS qa_qna_answer_id,
            qa.admin_id AS qa_admin_id,
            qa.qna_id AS qa_qna_id,
            qa.content AS qa_content,
            qa.is_deleted AS qa_is_deleted,
            qa.deleted_time AS qa_deleted_time,
            qa.deleted_id AS qa_deleted_id,
            qa.created_id AS qa_created_id,
            qa.created_time AS qa_created_time,
            qa.updated_id AS qa_updated_id,
            qa.updated_time AS qa_updated_time,

            -- Attachment
            a.attachment_id AS a_attachment_id,
            a.qna_id AS a_qna_id,
            a.file_name AS a_file_name,
            a.file_path AS a_file_path,
            a.width AS a_width,
            a.height AS a_height,
            a.size AS a_size,
            a.extension AS a_extension,
            a.is_active AS a_is_active,
            a.created_id AS a_created_id,
            a.created_time AS a_created_time,
            a.updated_id AS a_updated_id,
            a.updated_time AS a_updated_time
        FROM
            (
                SELECT
                    -- Qna
                    q.*,
                    -- QnaType
                    qt.qna_type_id as qt_qna_type_id,
                    qt.parent_qna_type_id as qt_parent_qna_type_id,
                    qt.name as qt_name,
                    qt.description as qt_description,
                    qt.is_order_id_active as qt_is_order_id_active,
                    qt.is_product_id_active as qt_is_product_id_active,
                    qt.is_active as qt_is_active,
                    qt.created_id as qt_created_id,
                    qt.created_time as qt_created_time,
                    qt.updated_id as qt_updated_id,
                    qt.updated_time as qt_updated_time
                FROM `Qna` AS q
                JOIN `QnaType` AS qt ON q.qna_type_id = qt.qna_type_id
                <if test="isActive != null">
                JOIN `ParentQnaType` AS pqt ON qt.parent_qna_type_id = pqt.parent_qna_type_id
                </if>
                WHERE q.is_deleted = false AND q.user_id = #{userId}
                <if test="isActive != null">
                    AND qt.is_active = #{isActive}
                    AND pqt.is_active = #{isActive}
                </if>
                LIMIT #{offset} , #{limit}
        )  AS qqt
        LEFT JOIN `QnaAnswer` AS qa ON qqt.qna_id = qa.qna_id
        LEFT JOIN `Attachment` AS a ON qqt.qna_id = a.qna_id
        WHERE  a.is_active = true
        ORDER BY qqt.created_time DESC
    </select>

    <select id="selectAllWithFilter" parameterType="map" resultMap="qnaMap">
        SELECT
            -- Qna
            q.*,
            -- QnaType
            qt.qna_type_id as qt_qna_type_id,
            qt.parent_qna_type_id as qt_parent_qna_type_id,
            qt.name as qt_name,
            qt.description as qt_description,
            qt.is_order_id_active as qt_is_order_id_active,
            qt.is_product_id_active as qt_is_product_id_active,
            qt.is_active as qt_is_active,
            qt.created_id as qt_created_id,
            qt.created_time as qt_created_time,
            qt.updated_id as qt_updated_id,
            qt.updated_time as qt_updated_time,
            -- User
            u.user_id as u_user_id,
            u.user_name as u_user_name,
            u.user_role as u_user_role,
            u.phone_number as u_phone_number,
            u.email as u_email,
            -- QnaAnswer
            qa.qna_answer_id AS qa_qna_answer_id,
            qa.admin_id AS qa_admin_id,
            qa.qna_id AS qa_qna_id,
            qa.content AS qa_content,
            qa.is_deleted AS qa_is_deleted,
            qa.deleted_time AS qa_deleted_time,
            qa.deleted_id AS qa_deleted_id,
            qa.created_id AS qa_created_id,
            qa.created_time AS qa_created_time,
            qa.updated_id AS qa_updated_id,
            qa.updated_time AS qa_updated_time
        FROM `Qna` AS q
        JOIN `QnaType` AS qt ON q.qna_type_id = qt.qna_type_id
        JOIN `User` AS u ON q.user_id = u.user_id
        <if test="isActive != null">
            JOIN `ParentQnaType` AS pqt ON qt.parent_qna_type_id = pqt.parent_qna_type_id
        </if>
        LEFT JOIN `QnaAnswer` AS qa ON q.qna_id = qa.qna_id
        WHERE q.is_deleted = false
        <if test="isActive != null">
            AND qt.is_active = #{isActive}
            AND pqt.is_active = #{isActive}
        </if>
        <if test="qnaTypeId != null">
            AND q.qna_type_id = #{qnaTypeId}
        </if>
        <if test="isAnswered != null">
            <if test="isAnswered == true">
                AND qa.qna_answer_id IS NOT NULL
            </if>
            <if test="isAnswered == false">
                AND qa.qna_answer_id IS NULL
            </if>
        </if>
        ORDER BY q.created_time DESC
        LIMIT #{offset} , #{limit}
    </select>

    <select id="selectWith" parameterType="int" resultMap="qnaMap">
        SELECT
            -- Qna
            q.*,
            -- QnaType
            qt.qna_type_id as qt_qna_type_id,
            qt.parent_qna_type_id as qt_parent_qna_type_id,
            qt.name as qt_name,
            qt.description as qt_description,
            qt.is_order_id_active as qt_is_order_id_active,
            qt.is_product_id_active as qt_is_product_id_active,
            qt.is_active as qt_is_active,
            qt.created_id as qt_created_id,
            qt.created_time as qt_created_time,
            qt.updated_id as qt_updated_id,
            qt.updated_time as qt_updated_time,
            -- ParentQnaType
            pqt.parent_qna_type_id as pqt_parent_qna_type_id,
            pqt.name as pqt_name,
            pqt.description as pqt_description,
            pqt.is_active as pqt_is_active,
            pqt.created_id as pqt_created_id,
            pqt.created_time as pqt_created_time,
            pqt.updated_id as pqt_updated_id,
            pqt.updated_time as pqt_updated_time,
            -- User
            u.user_id as u_user_id,
            u.user_name as u_user_name,
            u.user_role as u_user_role,
            u.phone_number as u_phone_number,
            u.email as u_email,
            -- QnaAnswer
            qa.qna_answer_id AS qa_qna_answer_id,
            qa.admin_id AS qa_admin_id,
            qa.qna_id AS qa_qna_id,
            qa.content AS qa_content,
            qa.is_deleted AS qa_is_deleted,
            qa.deleted_time AS qa_deleted_time,
            qa.deleted_id AS qa_deleted_id,
            qa.created_id AS qa_created_id,
            qa.created_time AS qa_created_time,
            qa.updated_id AS qa_updated_id,
            qa.updated_time AS qa_updated_time,
            -- Attachment
            a.attachment_id AS a_attachment_id,
            a.qna_id AS a_qna_id,
            a.file_name AS a_file_name,
            a.file_path AS a_file_path,
            a.width AS a_width,
            a.height AS a_height,
            a.size AS a_size,
            a.extension AS a_extension,
            a.is_active AS a_is_active,
            a.created_id AS a_created_id,
            a.created_time AS a_created_time,
            a.updated_id AS a_updated_id,
            a.updated_time AS a_updated_time
        FROM `Qna` AS q
        JOIN `QnaType` AS qt ON q.qna_type_id = qt.qna_type_id
        JOIN `ParentQnaType` AS pqt ON qt.parent_qna_type_id = pqt.parent_qna_type_id
        JOIN `User` AS u ON q.user_id = u.user_id
        LEFT JOIN `QnaAnswer` AS qa ON q.qna_id = qa.qna_id
        LEFT JOIN `Attachment` AS a ON q.qna_id = a.qna_id
        WHERE q.qna_id = #{qnaId}
            AND q.is_deleted = false
    </select>

    <select id="selectForTest" parameterType="map" resultType="com.toy2.shop29.qna.domain.QnaDto">
        SELECT
            *
        FROM `Qna`
        WHERE `qna_id` = #{qnaId}
        <if test="isDeleted != null">
            AND `is_deleted` = #{isDeleted}
        </if>
    </select>

    <!-- UPDATE -->
    <update id="update" parameterType="com.toy2.shop29.qna.domain.QnaDto">
        UPDATE `Qna`
        SET
            `qna_type_id` = #{qnaTypeId},
            `title` = #{title},
            `content` = #{content},
            `order_id` = #{orderId},
            `product_id` = #{productId},
            `updated_id` = #{userId},
            `updated_time` = now()
        WHERE `qna_id` = #{qnaId};
    </update>


    <!-- DELETE -->
    <update id="softDelete" parameterType="map">
        UPDATE `Qna`
        SET
            `is_deleted` = true,
            `deleted_time` = now(),
            `updated_id` = #{userId},
            `updated_time` = now()
        WHERE `qna_id` = #{qnaId};
    </update>


    <delete id="deleteAll" >
        DELETE FROM `Qna`;
    </delete>


</mapper>