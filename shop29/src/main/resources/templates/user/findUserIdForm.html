<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <link th:href="@{/css/bootstrap.min.css}" href="../../static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin-top: 50px;
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .form-control, .btn {
            height: 48px;
            font-size: 16px;
        }

        .btn-primary {
            background-color: #333;
            border: none;
            border-radius: 25px;
        }

        .btn-primary:hover {
            background-color: #555;
        }

        .btn-secondary {
            border-radius: 25px;
        }

        label {
            font-weight: bold;
            margin-top: 20px;
        }

        .field-error {
            color: #dc3545;
            font-size: 14px;
        }

        .text-center h2 {
            margin-bottom: 10px;
        }

        .text-muted {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="py-5 text-center">
        <h2>아이디 찾기</h2>
        <p class="text-muted">이메일 본인인증을 통해 아이디를 확인합니다.</p>
    </div>
    <form th:action="@{/user/findIdResult}" method="post">

        <div>
            <label for="email">이메일</label>
            <div class="input-group">
                <input type="text" id="email" name="email"
                       class="form-control" placeholder="이메일 입력 ex) sample@naver.com">
                <button type="button" class="btn btn-outline-secondary" onclick="sendVerificationEmail()">인증 요청</button>
            </div>
        </div>

        <div id="emailVerification" style="display: none;">
            <label for="verificationCode">인증번호</label>
            <input type="text" id="verificationCode" class="form-control" placeholder="이메일로 받은 인증번호 입력">
            <button type="button" class="btn btn-outline-secondary" onclick="verifyEmail()">인증 확인</button>
        </div>

        <button class="w-100 btn btn-primary btn-lg mt-4"  id="findIdButton" type="submit" disabled >아이디 찾기</button>
    </form>
</div>

<script>

    function sendVerificationEmail() {
        const email = document.getElementById('email').value;

        // 이메일 형식 유효성 검사
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            alert("올바른 이메일 형식이 아닙니다.");
            return;
        }

        fetch('/user/checkUserEmail?userEmail=' + encodeURIComponent(email))
            .then(response => response.json())
            .then(data => {
                if (!data.exists) {
                    alert('이메일이 존재하지않습니다.');
                } else {
                    // 중복이 아니면 이메일 인증 코드 발송
                    const formData = new URLSearchParams();
                    formData.append('email', email);

                    return fetch('/email/sendVerificationCode', {
                        method: 'POST',  // POST 요청을 사용
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'  // 폼 데이터 형식으로 전송
                        },
                        body: formData.toString()  // URLSearchParams를 문자열로 변환하여 전송
                    });
                }
            })
            .then(response => {
                if (response && !response.ok) {
                    throw new Error('서버응답 오류: ' + response.statusText);
                }
                return response && response.json();
            })
            .then(data => {
                if (data && data.success) {
                    document.getElementById('emailVerification').style.display = 'block';
                    alert('인증 이메일이 발송되었습니다.');
                } else if (data) {
                    alert('이메일 발송에 실패했습니다.');
                }
            })
            .catch(error => console.error('Error:', error));
    }


    function verifyEmail() {
        const email = document.getElementById('email').value;
        const verificationCode = document.getElementById('verificationCode').value;

        // 이메일 인증 확인 API 호출
        fetch('/email/verifyCode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                email: email,
                code: verificationCode
            })
        })
            .then(response => response.text())
            .then(data => {
                console.log("Server response:", data);
                if (data === "이메일 인증 성공.") {
                    alert('이메일 인증이 완료되었습니다.');
                    // 회원가입 버튼 활성화
                    document.getElementById('findIdButton').disabled = false;
                } else {
                    alert('인증번호가 올바르지 않습니다. 다시 입력해주세요.');
                }
            })
            .catch(error => console.error('Error:', error));
    }

</script>
</body>
</html>
